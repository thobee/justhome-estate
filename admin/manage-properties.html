<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Properties - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      .sidebar {
        width: 280px;
        transition: all 0.3s ease;
      }

      /* Responsive Styles */
      @media (max-width: 1024px) {
        .main-content {
          margin-left: 0 !important;
        }
        .sidebar {
          transform: translateX(-100%);
          z-index: 40;
        }
        .sidebar.active {
          transform: translateX(0);
        }
        .sidebar-overlay {
          display: none;
        }
        .sidebar.active + .sidebar-overlay {
          display: block;
        }
      }

      @media (max-width: 768px) {
        .action-bar {
          flex-direction: column;
          align-items: stretch !important;
        }
        .action-bar > div {
          width: 100%;
        }
        .search-input {
          width: 100% !important;
        }
        .property-grid {
          grid-template-columns: repeat(1, 1fr) !important;
        }
      }

      @media (max-width: 640px) {
        .header-content {
          padding: 0.75rem !important;
        }
        .main-padding {
          padding: 1rem !important;
        }
        .property-features {
          grid-template-columns: repeat(2, 1fr) !important;
        }
      }

      /* Property Card Animations */
      .property-card {
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .property-card:hover {
        transform: translateY(-4px);
      }
      .property-card img {
        transition: transform 0.3s ease;
      }
      .property-card:hover img {
        transform: scale(1.05);
      }

      /* Loading Animation */
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }
      .loading-skeleton {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(
          to right,
          #f6f7f8 0%,
          #edeef1 20%,
          #f6f7f8 40%,
          #f6f7f8 100%
        );
        background-size: 1000px 100%;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Admin Header -->
    <header class="bg-white border-b border-gray-200 fixed w-full z-30">
      <div class="px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button
            id="sidebar-toggle"
            class="p-2 rounded-lg hover:bg-gray-100 text-gray-600"
          >
            <i class="fas fa-bars"></i>
          </button>
          <div class="flex items-center gap-2">
            <img
              src="../images/1logo.png"
              alt="JustHome Logo"
              class="h-8 w-auto"
            />
            <span class="text-xl font-bold text-gray-800"
              >Property Management</span
            >
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button
            class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 relative"
          >
            <i class="fas fa-bell"></i>
            <span
              class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"
            ></span>
          </button>
          <div class="relative group">
            <button
              class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100"
            >
              <img
                src="../images/1logo.png"
                alt="Admin"
                class="w-8 h-8 rounded-full object-cover"
              />
              <span class="text-sm font-medium text-gray-700">Admin</span>
              <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </button>
            <div
              class="absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg py-2 hidden group-hover:block"
            >
              <a
                href="#profile"
                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-user w-5"></i>
                Profile
              </a>
              <a
                href="#settings"
                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-cog w-5"></i>
                Settings
              </a>
              <hr class="my-2 border-gray-100" />
              <button
                onclick="handleLogout()"
                class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              >
                <i class="fas fa-sign-out-alt w-5"></i>
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside
      class="sidebar bg-white border-r border-gray-200 h-screen fixed top-0 left-0 pt-16 transition-all duration-300"
    >
      <nav class="p-4">
        <div class="space-y-4">
          <a
            href="dashboard.html"
            class="flex items-center gap-2 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a
            href="properties.html"
            class="flex items-center gap-2 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-plus-circle"></i>
            <span>Add Property</span>
          </a>
          <a
            href="manage-properties.html"
            class="flex items-center gap-2 text-blue-600 bg-blue-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-building"></i>
            <span>Manage Properties</span>
          </a>
          <a
            href="users.html"
            class="flex items-center gap-2 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-users"></i>
            <span>Users</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Sidebar Overlay -->
    <div
      class="sidebar-overlay fixed inset-0 bg-black/50 backdrop-blur-sm hidden"
      onclick="document.querySelector('.sidebar').classList.remove('active')"
    ></div>

    <!-- Main Content -->
    <main
      class="main-content ml-[280px] pt-24 p-6 main-padding transition-all duration-300"
    >
      <!-- Properties Grid -->
      <div
        class="property-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <!-- Property Card -->
        <div
          class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow"
        >
          <div class="relative">
            <img
              src="../images/img1.png"
              alt="Property"
              class="w-full h-48 object-cover"
            />
            <span
              class="absolute top-4 left-4 bg-blue-600 text-white px-2 py-1 rounded text-sm"
            >
              For Rent
            </span>
            <button
              class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-2 rounded-full text-gray-700 hover:text-red-500 transition-colors"
            >
              <i class="fas fa-heart"></i>
            </button>
          </div>
          <div class="p-4">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-semibold text-gray-800">
                  Modern Apartment
                </h3>
                <p class="text-gray-600 text-sm">
                  <i class="fas fa-map-marker-alt mr-1"></i>
                  Lagos, Nigeria
                </p>
              </div>
              <p class="text-lg font-bold text-blue-600">â‚¦250,000/mo</p>
            </div>
            <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
              <span><i class="fas fa-bed mr-1"></i> 3 Beds</span>
              <span><i class="fas fa-bath mr-1"></i> 2 Baths</span>
              <span><i class="fas fa-ruler-combined mr-1"></i> 1,200 sqft</span>
            </div>
            <div
              class="flex items-center justify-between pt-4 border-t border-gray-100"
            >
              <div class="flex items-center gap-2">
                <button class="text-blue-600 hover:text-blue-700">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-600 hover:text-red-700">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <span
                  class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                >
                  Active
                </span>
                <button class="text-gray-600 hover:text-blue-600">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Add more property cards here -->
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-6">
        <div class="text-sm text-gray-700">
          Showing <span class="font-medium">1</span> to
          <span class="font-medium">10</span> of
          <span class="font-medium">20</span> properties
        </div>
        <div class="flex gap-2">
          <button
            class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50"
          >
            Previous
          </button>
          <button
            class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50"
          >
            Next
          </button>
        </div>
      </div>
    </main>

    <!-- Firebase Scripts -->
    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBo5JRHCEmp3PftMAmHQxJspCPzX0RRPKY",
        authDomain: "estatejs-7c477.firebaseapp.com",
        projectId: "estatejs-7c477",
        storageBucket: "estatejs-7c477.appspot.com",
        messagingSenderId: "156544193291",
        appId: "1:156544193291:web:96e317eb953cf7194fc80e",
        measurementId: "G-T5HCCR6C7M",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // Auth guard for admin pages
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href =
            "../signin.html?redirect=admin/manage-properties.html";
          return;
        }

        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);

          if (!userSnap.exists() || userSnap.data().role !== "admin") {
            console.log("Access check failed:", {
              exists: userSnap.exists(),
              role: userSnap.exists() ? userSnap.data().role : null,
            });
            alert("Access denied. Admin privileges required.");
            await signOut(auth);
            window.location.href = "../index.html";
            return;
          }
          console.log("Access check passed for user:", user.email);
        } catch (error) {
          console.error("Error checking admin role:", error);
          alert("Error verifying permissions. Please try again.");
          window.location.href = "../index.html";
        }
      });

      // Create loading skeleton
      function createLoadingSkeleton() {
        return `
          <div class="bg-white rounded-2xl shadow-sm overflow-hidden animate-pulse">
            <div class="w-full h-60 bg-gray-200"></div>
            <div class="p-6">
              <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                  <div class="h-6 bg-gray-200 rounded-md w-3/4 mb-2"></div>
                  <div class="h-4 bg-gray-200 rounded-md w-1/2"></div>
                </div>
                <div class="w-24 h-6 bg-gray-200 rounded-md"></div>
              </div>
              <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="flex items-center gap-2">
                  <div class="w-10 h-10 rounded-full bg-gray-200"></div>
                  <div class="h-4 bg-gray-200 rounded-md w-12"></div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-10 h-10 rounded-full bg-gray-200"></div>
                  <div class="h-4 bg-gray-200 rounded-md w-12"></div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-10 h-10 rounded-full bg-gray-200"></div>
                  <div class="h-4 bg-gray-200 rounded-md w-12"></div>
                </div>
              </div>
              <div class="pt-4 border-t border-gray-100">
                <div class="h-4 bg-gray-200 rounded-md w-1/3"></div>
              </div>
            </div>
          </div>
        `;
      }

      // Load properties from Firestore
      async function loadProperties() {
        try {
          console.log("Loading properties from Firestore...");
          const propertiesGrid = document.querySelector(".grid");

          // Add debug logging for property data
          console.log("Debug logging enabled for property loading...");

          // Show loading skeletons
          propertiesGrid.innerHTML = Array(6)
            .fill(createLoadingSkeleton())
            .join("");

          const propertiesRef = collection(db, "properties");
          const snapshot = await getDocs(propertiesRef);

          // Clear loading skeletons
          propertiesGrid.innerHTML = "";

          console.log("Found", snapshot.size, "properties");
          snapshot.forEach((doc) => {
            const property = doc.data();
            console.log("Property data:", {
              id: doc.id,
              image: property.image,
              imageUrl: property.imageUrl,
              images: property.images,
              title: property.title,
            });
            const propertyCard = createPropertyCard(doc.id, property);
            propertiesGrid.appendChild(propertyCard);
          });
        } catch (error) {
          console.error("Error loading properties:", error);
        }
      }

      // Create property card element
      function createPropertyCard(id, property) {
        // Debug log for image paths
        console.log("Creating card for property:", {
          id,
          title: property.title,
          imageUrl: property.imageUrl,
          image: property.image,
          images: property.images,
          cloudinaryUrl: property.cloudinaryUrl,
        });

        const card = document.createElement("div");
        card.className =
          "property-card bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-lg transition-all duration-300 hover:-translate-y-1";
        card.innerHTML = `
          <div class="relative group">
            <div class="overflow-hidden">
              <img
                src="${
                  property.image ||
                  property.imageUrl ||
                  property.images?.[0] ||
                  "../images/img1.png"
                }"
                alt="${property.title}"
                class="w-full h-60 object-cover transform transition-transform duration-300 group-hover:scale-110"
                onerror="this.src='../images/img1.png'"
              />
            </div>
            <div class="absolute top-4 left-4 flex flex-col gap-2">
              <span class="bg-blue-600/90 backdrop-blur-sm text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                For ${property.type}
              </span>
              <span class="px-3 py-1.5 rounded-lg text-xs font-medium ${
                property.status === "active"
                  ? "bg-green-500/90 text-white"
                  : "bg-gray-600/90 text-white"
              } backdrop-blur-sm">
                ${property.status || "Unavailable"}
              </span>
            </div>
          <div class="p-4">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-semibold text-gray-800">${
                  property.title
                }</h3>
                <p class="text-gray-600 text-sm">
                  <i class="fas fa-map-marker-alt mr-1"></i>
                  ${property.location}
                </p>
              </div>
              <p class="text-lg font-bold text-blue-600">â‚¦${
                property.price
              }/mo</p>
            </div>
            <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
              <span><i class="fas fa-bed mr-1"></i> ${
                property.bedrooms
              } Beds</span>
              <span><i class="fas fa-bath mr-1"></i> ${
                property.bathrooms
              } Baths</span>
              <span><i class="fas fa-ruler-combined mr-1"></i> ${
                property.size || "N/A"
              } sqft</span>
            </div>
            <div class="flex items-center justify-between pt-4 border-t border-gray-100">
              <div class="flex items-center gap-2">
                <button onclick="editProperty('${id}')" class="text-blue-600 hover:text-blue-700">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteProperty('${id}')" class="text-red-600 hover:text-red-700">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                  property.status === "active"
                    ? "bg-green-100 text-green-800"
                    : "bg-gray-100 text-gray-800"
                }">
                  ${property.status || "Active"}
                </span>
                <button class="text-gray-600 hover:text-blue-600">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        return card;
      }

      // Delete property
      async function deleteProperty(id) {
        if (!confirm("Are you sure you want to delete this property?")) return;

        try {
          const propertyRef = doc(db, "properties", id);
          await deleteDoc(propertyRef);
          console.log("Property deleted successfully:", id);
          loadProperties(); // Refresh the list
        } catch (error) {
          console.error("Error deleting property:", error);
          alert("Error deleting property. Please try again.");
        }
      }

      // Edit property
      function editProperty(id) {
        window.location.href = `../add-property.html?edit=${id}`;
      }

      // Handle logout
      async function handleLogout() {
        try {
          await signOut(auth);
          console.log("User signed out successfully");
          window.location.href = "../index.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      }

      // Expose functions to window for HTML access
      window.handleLogout = handleLogout;
      window.deleteProperty = deleteProperty;
      window.editProperty = editProperty;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Document loaded, initializing...");
        loadProperties();

        // Sidebar toggle
        document
          .getElementById("sidebar-toggle")
          .addEventListener("click", () => {
            document.querySelector(".sidebar").classList.toggle("active");
          });
      });
    </script>
  </body>
</html>
