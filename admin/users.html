<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Management - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      .sidebar {
        width: 280px;
        transition: all 0.3s ease;
      }
      @media (max-width: 768px) {
        .sidebar {
          width: 0;
          position: fixed;
        }
        .sidebar.active {
          width: 280px;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Admin Header -->
    <header class="bg-white border-b border-gray-200 fixed w-full z-30">
      <div class="px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button
            id="sidebar-toggle"
            class="p-2 rounded-lg hover:bg-gray-100 text-gray-600"
          >
            <i class="fas fa-bars"></i>
          </button>
          <div class="flex items-center gap-2">
            <img
              src="../images/1logo.png"
              alt="JustHome Logo"
              class="h-8 w-auto"
            />
            <span class="text-xl font-bold text-gray-800">User Management</span>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button
            class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 relative"
          >
            <i class="fas fa-bell"></i>
            <span
              class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"
            ></span>
          </button>
          <div class="relative group">
            <button
              class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100"
            >
              <img
                src="../images/1logo.png"
                alt="Admin"
                class="w-8 h-8 rounded-full object-cover"
              />
              <span class="text-sm font-medium text-gray-700">Admin</span>
              <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </button>
            <div
              class="absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg py-2 hidden group-hover:block"
            >
              <a
                href="#profile"
                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-user w-5"></i>
                Profile
              </a>
              <a
                href="#settings"
                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-cog w-5"></i>
                Settings
              </a>
              <hr class="my-2 border-gray-100" />
              <button
                onclick="handleLogout()"
                class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              >
                <i class="fas fa-sign-out-alt w-5"></i>
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside
      class="sidebar bg-white border-r border-gray-200 h-screen fixed top-0 left-0 pt-16 transition-all duration-300"
    >
      <nav class="p-4">
        <div class="space-y-4">
          <a
            href="dashboard.html"
            class="flex items-center gap-2 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a
            href="properties.html"
            class="flex items-center gap-2 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-plus-circle"></i>
            <span>Add Property</span>
          </a>
          <a
            href="manage-properties.html"
            class="flex items-center gap-2 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-building"></i>
            <span>Manage Properties</span>
          </a>
          <a
            href="users.html"
            class="flex items-center gap-2 text-blue-600 bg-blue-50 px-4 py-2 rounded-lg"
          >
            <i class="fas fa-users"></i>
            <span>Users</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="ml-[280px] pt-16 p-6">
      <!-- Actions Bar -->
      <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-4">
          <button
            onclick="openAddUserModal()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
          >
            <i class="fas fa-user-plus"></i>
            Add New User
          </button>
          <button
            onclick="openBulkActionsModal()"
            class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
          >
            <i class="fas fa-tasks"></i>
            Bulk Actions
          </button>
          <button
            onclick="refreshUsers()"
            class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
          >
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
        <div class="flex gap-4">
          <div class="relative">
            <input
              type="text"
              id="search-input"
              placeholder="Search users..."
              class="w-64 pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
              onkeyup="handleSearch(event)"
            />
            <i
              class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
            ></i>
          </div>
          <select
            id="role-filter"
            onchange="handleRoleFilter(this.value)"
            class="px-4 py-2 border border-gray-200 rounded-lg bg-white text-sm font-medium cursor-pointer focus:outline-none focus:border-blue-500"
          >
            <option value="">All Roles</option>
            <option value="admin">Admin</option>
            <option value="agent">Agent</option>
            <option value="user">User</option>
          </select>
          <button
            onclick="exportUsers()"
            class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
          >
            <i class="fas fa-download"></i>
            Export
          </button>
        </div>
      </div>

      <!-- Admin Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Total Users</p>
              <p class="text-2xl font-bold text-gray-800" id="total-users">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-users text-blue-600 text-xl"></i>
            </div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Active Users</p>
              <p class="text-2xl font-bold text-gray-800" id="active-users">0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <i class="fas fa-user-check text-green-600 text-xl"></i>
            </div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Admins</p>
              <p class="text-2xl font-bold text-gray-800" id="admin-count">0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-user-shield text-purple-600 text-xl"></i>
            </div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Agents</p>
              <p class="text-2xl font-bold text-gray-800" id="agent-count">0</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
              <i class="fas fa-user-tie text-orange-600 text-xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="min-w-full overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  User
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Role
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Properties
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Joined Date
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Last Active
                </th>
                <th
                  class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <!-- Sample User Row -->
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <img
                      class="h-10 w-10 rounded-full object-cover"
                      src="../images/1logo.png"
                      alt=""
                    />
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900">
                        John Doe
                      </div>
                      <div class="text-sm text-gray-500">john@example.com</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span
                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800"
                  >
                    Agent
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span
                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
                  >
                    Active
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  12
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  2025-08-01
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  2025-09-04
                </td>
                <td
                  class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
                >
                  <button class="text-blue-600 hover:text-blue-900 mr-3">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="text-red-600 hover:text-red-900">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              <!-- Add more rows as needed -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-6">
        <div class="text-sm text-gray-700">
          Showing <span class="font-medium">1</span> to
          <span class="font-medium">10</span> of
          <span class="font-medium">20</span> results
        </div>
        <div class="flex gap-2">
          <button
            class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50"
          >
            Previous
          </button>
          <button
            class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50"
          >
            Next
          </button>
        </div>
      </div>
    </main>

    <!-- Add User Modal -->
    <div
      id="addUserModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
          <div class="p-6 border-b border-gray-100">
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-800">Add New User</h2>
              <button
                onclick="closeAddUserModal()"
                class="text-gray-400 hover:text-gray-600"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="p-6">
            <form id="addUserForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Full Name
                </label>
                <input
                  type="text"
                  name="fullName"
                  required
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  required
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Role
                </label>
                <select
                  name="role"
                  required
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
                >
                  <option value="">Select role</option>
                  <option value="admin">Admin</option>
                  <option value="agent">Agent</option>
                  <option value="user">User</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Password
                </label>
                <input
                  type="password"
                  name="password"
                  required
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Confirm Password
                </label>
                <input
                  type="password"
                  name="confirmPassword"
                  required
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500"
                />
              </div>
            </form>
          </div>
          <div class="p-6 border-t border-gray-100 flex justify-end gap-4">
            <button
              onclick="closeAddUserModal()"
              class="px-4 py-2 text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onclick="submitUser()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Add User
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        limit,
        getDocs,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        updateDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBo5JRHCEmp3PftMAmHQxJspCPzX0RRPKY",
        authDomain: "estatejs-7c477.firebaseapp.com",
        projectId: "estatejs-7c477",
        storageBucket: "estatejs-7c477.appspot.com",
        messagingSenderId: "156544193291",
        appId: "1:156544193291:web:96e317eb953cf7194fc80e",
        measurementId: "G-T5HCCR6C7M",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Auth guard for admin pages
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "../signin.html?redirect=admin/users.html";
          return;
        }

        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);

          if (!userSnap.exists() || userSnap.data().role !== "admin") {
            console.log("Access check failed:", {
              exists: userSnap.exists(),
              role: userSnap.exists() ? userSnap.data().role : null,
            });
            alert("Access denied. Admin privileges required.");
            await signOut(auth);
            window.location.href = "../index.html";
            return;
          }
          console.log("Access check passed for user:", user.email);
        } catch (error) {
          console.error("Error checking admin role:", error);
          alert("Error verifying permissions. Please try again.");
          window.location.href = "../index.html";
        }
      });

      // Loading state management
      let isLoading = true;

      // Create loading skeleton
      function createLoadingSkeleton() {
        return `
          <tr class="animate-pulse">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-gray-200 rounded-full"></div>
                <div class="ml-4">
                  <div class="h-4 bg-gray-200 rounded w-32 mb-2"></div>
                  <div class="h-3 bg-gray-200 rounded w-48"></div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="h-6 bg-gray-200 rounded w-16"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="h-6 bg-gray-200 rounded w-20"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="h-4 bg-gray-200 rounded w-8"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="h-4 bg-gray-200 rounded w-24"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="h-4 bg-gray-200 rounded w-20"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex justify-end gap-3">
                <div class="w-8 h-8 bg-gray-200 rounded"></div>
                <div class="w-8 h-8 bg-gray-200 rounded"></div>
              </div>
            </td>
          </tr>
        `;
      }

      // Load Users
      let currentPage = 1;
      const usersPerPage = 10;
      let totalUsers = 0;
      let lastVisible = null;

      async function loadUsers() {
        try {
          console.log("Loading users from Firestore...");
          isLoading = true;

          const tbody = document.querySelector("tbody");
          tbody.innerHTML = ""; // Clear existing rows

          // Show loading skeletons
          for (let i = 0; i < 5; i++) {
            tbody.innerHTML += createLoadingSkeleton();
          }

          const usersQuery = query(
            collection(db, "users"),
            orderBy("createdAt", "desc"),
            limit(usersPerPage)
          );

          const snapshot = await getDocs(usersQuery);
          lastVisible = snapshot.docs[snapshot.docs.length - 1];

          // Clear loading skeletons
          tbody.innerHTML = "";

          console.log("Found", snapshot.size, "users");
          snapshot.forEach((doc) => {
            const userData = doc.data();
            console.log("User data:", {
              id: doc.id,
              email: userData.email,
              role: userData.role,
              active: userData.active,
            });
            const row = createUserRow(doc.id, userData);
            tbody.appendChild(row);
          });

          // Update pagination
          const totalSnapshot = await getDocs(collection(db, "users"));
          totalUsers = totalSnapshot.size;
          updatePagination();
          updateStats();
          isLoading = false;
        } catch (error) {
          console.error("Error loading users:", error);
          isLoading = false;
          const tbody = document.querySelector("tbody");
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center">
                <div class="flex flex-col items-center">
                  <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                  <p class="text-gray-600 text-lg mb-2">Failed to load users</p>
                  <p class="text-gray-500 text-sm">Please try again later</p>
                  <button onclick="loadUsers()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Try Again
                  </button>
                </div>
              </td>
            </tr>
          `;
        }
      }

      function createUserRow(userId, userData) {
        const tr = document.createElement("tr");
        const lastActive = userData.lastActive
          ? new Date(userData.lastActive.toDate()).toLocaleDateString()
          : "N/A";
        const joinDate = userData.createdAt
          ? new Date(userData.createdAt.toDate()).toLocaleDateString()
          : "N/A";

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <img class="h-10 w-10 rounded-full object-cover" src="${
                userData.photoURL || "../images/1logo.png"
              }" alt="" />
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">${
                  userData.fullName
                }</div>
                <div class="text-sm text-gray-500">${userData.email}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
              ${userData.role || "User"}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
              userData.active
                ? "bg-green-100 text-green-800"
                : "bg-red-100 text-red-800"
            }">
              ${userData.active ? "Active" : "Inactive"}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${userData.propertyCount || 0}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${joinDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${lastActive}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="editUser('${userId}')" class="text-blue-600 hover:text-blue-900 mr-3">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteUser('${userId}')" class="text-red-600 hover:text-red-900">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        return tr;
      }

      async function submitUser() {
        const form = document.getElementById("addUserForm");
        const formData = new FormData(form);
        const userData = {
          fullName: formData.get("fullName"),
          email: formData.get("email"),
          role: formData.get("role"),
          active: true,
          createdAt: serverTimestamp(),
          lastActive: serverTimestamp(),
          propertyCount: 0,
        };

        try {
          console.log("Creating new user:", userData.email);

          // Create auth user
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            userData.email,
            formData.get("password")
          );

          // Add user to Firestore
          await setDoc(doc(db, "users", userCredential.user.uid), userData);

          console.log("User created successfully:", userCredential.user.uid);
          closeAddUserModal();
          loadUsers(); // Refresh the list
          form.reset();
        } catch (error) {
          console.error("Error creating user:", error);
          let errorMessage = "Error creating user: " + error.message;

          if (error.code === "auth/email-already-in-use") {
            errorMessage = "This email is already registered.";
          } else if (error.code === "auth/weak-password") {
            errorMessage = "Password should be at least 6 characters.";
          }

          alert(errorMessage);
        }
      }

      async function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) return;

        try {
          console.log("Deleting user:", userId);

          // Delete from Firestore
          await deleteDoc(doc(db, "users", userId));

          // Note: Firebase Auth users cannot be deleted from client-side
          // This would need to be done from server-side or Firebase Admin SDK

          console.log("User deleted from database:", userId);
          loadUsers(); // Refresh the list
        } catch (error) {
          console.error("Error deleting user:", error);
          alert("Error deleting user. Please try again.");
        }
      }

      async function editUser(userId) {
        console.log("Edit user functionality - to be implemented:", userId);
        // TODO: Implement edit user modal
        alert("Edit user functionality coming soon!");
      }

      function updatePagination() {
        const totalPages = Math.ceil(totalUsers / usersPerPage);
        document.querySelector(".text-gray-700").innerHTML = `
          Showing <span class="font-medium">${
            (currentPage - 1) * usersPerPage + 1
          }</span> to
          <span class="font-medium">${Math.min(
            currentPage * usersPerPage,
            totalUsers
          )}</span> of
          <span class="font-medium">${totalUsers}</span> results
        `;
      }

      // Update admin statistics
      async function updateStats() {
        try {
          const usersSnapshot = await getDocs(collection(db, "users"));
          const users = usersSnapshot.docs.map(doc => doc.data());

          const totalUsers = users.length;
          const activeUsers = users.filter(user => user.active).length;
          const adminCount = users.filter(user => user.role === "admin").length;
          const agentCount = users.filter(user => user.role === "agent").length;

          document.getElementById("total-users").textContent = totalUsers;
          document.getElementById("active-users").textContent = activeUsers;
          document.getElementById("admin-count").textContent = adminCount;
          document.getElementById("agent-count").textContent = agentCount;
        } catch (error) {
          console.error("Error updating stats:", error);
        }
      }

      // Search functionality
      function handleSearch(event) {
        if (event.key === "Enter") {
          const searchTerm = event.target.value.toLowerCase();
          const rows = document.querySelectorAll("tbody tr");

          rows.forEach(row => {
            const name = row.querySelector(".text-gray-900")?.textContent.toLowerCase() || "";
            const email = row.querySelector(".text-gray-500")?.textContent.toLowerCase() || "";

            if (name.includes(searchTerm) || email.includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        }
      }

      // Role filter functionality
      function handleRoleFilter(role) {
        const rows = document.querySelectorAll("tbody tr");

        rows.forEach(row => {
          const roleBadge = row.querySelector(".rounded-full")?.textContent.toLowerCase() || "";

          if (!role || roleBadge.includes(role.toLowerCase())) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      // Refresh users
      function refreshUsers() {
        console.log("Refreshing users...");
        loadUsers();
        updateStats();
      }

      // Export users functionality
      function exportUsers() {
        console.log("Exporting users...");
        // TODO: Implement CSV export
        alert("Export functionality coming soon!");
      }

      // Bulk actions modal
      function openBulkActionsModal() {
        console.log("Bulk actions functionality coming soon!");
        alert("Bulk actions functionality coming soon!");
      }

      // Event Listeners
      document
        .getElementById("sidebar-toggle")
        .addEventListener("click", () => {
          const sidebar = document.querySelector(".sidebar");
          sidebar.classList.toggle("active");
        });

      function openAddUserModal() {
        document.getElementById("addUserModal").classList.remove("hidden");
      }

      function closeAddUserModal() {
        document.getElementById("addUserModal").classList.add("hidden");
      }

      // Handle Logout
      async function handleLogout() {
        try {
          await signOut(auth);
          console.log("User signed out successfully");
          window.location.href = "../index.html";
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error signing out. Please try again.");
        }
      }

      // Expose functions to window
      window.loadUsers = loadUsers;
      window.submitUser = submitUser;
      window.deleteUser = deleteUser;
      window.editUser = editUser;
      window.openAddUserModal = openAddUserModal;
      window.closeAddUserModal = closeAddUserModal;
      window.handleLogout = handleLogout;
      window.updateStats = updateStats;
      window.handleSearch = handleSearch;
      window.handleRoleFilter = handleRoleFilter;
      window.refreshUsers = refreshUsers;
      window.exportUsers = exportUsers;
      window.openBulkActionsModal = openBulkActionsModal;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Document loaded, initializing users page...");
        loadUsers();
      });
    </script>
  </body>
</html>
